```{r}
R.utils::sourceDirectory('C:/Users/marec/Docs/tagproc/R')
tag_folder <- "G:/Shared drives/METR_TagData/Killer whale/Sat tagging/Oo Tag 034/OoTag034-94815"
prettifyWC(tag_folder)
WCpretty_dir <- paste0(tag_folder,'/WC-pretty')
Argos_data <- read.csv(paste0(WCpretty_dir,"/94815-Locations.csv"))
DF_data <- douglas.filter(Argos_data, argos_method = 'K', method = 'DAR', 
                          keep_lc = 2, maxredun = 3, duplrec = 'offset', 
                          minrate = 20, ratecoef = 25, r_only = FALSE)$all
```

```{r}
stime <- lubridate::ceiling_date(DF_data$Date[1], unit = 'days')
end <- lubridate::floor_date(DF_data$Date[nrow(DF_data)], unit = 'days')
crawl_times <- c()
time <- stime
while (time <= end) {
  crawl_times <- c(crawl_times, time)
  time <- time + (12*60*60)
}
crawl_times <- lubridate::force_tz(as.POSIXct(crawl_times, origin = "1970-01-01 08:00"), tzone = 'UTC')
if (stime != crawl_times[1]) {stop('crawl_times is off')}
CRAWL_data <- crawl.apply(DF_data, model.interval = crawl_times, crs = 3310)
Ootrack <- CRAWL_data$preds
SL_data <- sun.moon(Ootrack)
BATHY_track <- bathy.sync(SL_data)
View(BATHY_track)
```

```{r}
Beh_data <- read.csv(paste0(WCpretty_dir,"/94793-Behavior.csv"))
split_Beh <- split.dive.msg(Beh_data, kclusters = 2)
crawl_times <- lubridate::force_tz(as.POSIXct(split_Beh$Dives$StartTime, format = "%m/%d/%Y %H:%M:%S"), tzone = 'UTC')
CRAWL_dives <- crawl.apply(DF_data, model.interval = crawl_times, crs = 2230)
DIVE_dives <- bhvr.interpolate(split_Beh$Dives, CRAWL_dives$preds, matching = F)
SL_dives <- sun.moon(DIVE_dives)
BATHY_dives <- bathy.sync(SL_dives)
View(BATHY_dives)
```

```{r}
write.csv(DF_data, paste0(WCpretty_dir,'/94815-DFLocs_2lc-3mr-20mr-25rc.csv'), row.names=F)

write.csv(BATHY_track, paste0(WCpretty_dir,'/94815-12hCRAWL_Environment.csv'), row.names=F)

write.csv(BATHY_dives, paste0(WCpretty_dir,'/94815-Behavior_Environment.csv'), row.names=F)
```
